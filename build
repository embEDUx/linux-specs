#! /bin/bash -e

#####################
# Configuration     # 							     
#####################

### Sources
SRC_DIR="/var/tmp/embedux/download"
KERNEL_URL="http://www.kernel.org/pub/linux/kernel/v3.x"
KERNEL_FILE="linux-3.17.tar.gz"

### Patches
GPATCH_DIR="gentoo-patches"
GPATCH_URL="http://dev.gentoo.org/~mpagano/genpatches/tarballs"
GPATCH_BASE_FILE="genpatches-3.17-5.base.tar.xz"
GPATCH_EXTRAS_FILE="genpatches-3.17-5.extras.tar.xz"

#####################
# Script            #
#####################

### Prepare folder
mkdir -p ${SRC_DIR}

### Kernel sources and patches
if [ ! -e ${SRC_DIR}/${KERNEL_FILE} ]
  then
    echo "${KERNEL_FILE} not found in ${SRC_DIR}"
    echo "Downloading ${KERNEL_FILE} from ${KERNEL_URL}"
    wget ${KERNEL_URL}/${KERNEL_FILE} -P ${SRC_DIR}
fi

echo "Extracting ${KERNEL_FILE}"
tar -xf ${SRC_DIR}/${KERNEL_FILE} --strip 1

### Gentoo patchset
mkdir ${GPATCH_DIR}

if [ ! -e ${SRC_DIR}/${GPATCH_BASE_FILE} ]
  then
    echo "${GPATCH_BASE_FILE} not found in ${SRC_DIR}"
    echo "Downloading ${GPATCH_BASE_FILE} from ${KERNEL_URL}"
    wget ${GPATCH_URL}/${GPATCH_BASE_FILE} -P ${SRC_DIR}
fi

echo "Extracting ${GPATCH_BASE_FILE}"
tar -xf ${SRC_DIR}/${GPATCH_BASE_FILE} -C ${GPATCH_DIR}

if [ ! -e ${SRC_DIR}/${GPATCH_EXTRAS_FILE} ]
  then
    echo "${GPATCH_EXTRAS_FILE} not found in ${SRC_DIR}"
    echo "Downloading ${GPATCH_EXTRAS_FILE} from ${KERNEL_URL}"
    wget ${GPATCH_URL}/${GPATCH_EXTRAS_FILE} -P ${SRC_DIR}
fi

echo "Extracting ${GPATCH_EXTRAS_FILE}"
tar -xf ${SRC_DIR}/${GPATCH_EXTRAS_FILE} -C ${GPATCH_DIR}

### Apply gentoo patchset
echo "Applying gentoo patches"
for patch in $(ls ${GPATCH_DIR}/*.patch 2>/dev/null) 
	do patch -t -p1 < $patch
done

