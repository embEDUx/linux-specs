#! /bin/bash -e

#####################
# Configuration     # 							     
#####################

### Sources
SRC_DIR="/var/tmp/embedux/download"
KERNEL_URL="http://www.kernel.org/pub/linux/kernel/v3.x"
KERNEL_FILE="linux-3.17.tar.gz"
KERNEL_SHA="sha256sums.asc"

### Patches
GPATCH_DIR="gentoo-patches"
GPATCH_URL="http://dev.gentoo.org/~mpagano/genpatches/tarballs"
GPATCH_BASE_FILE="genpatches-3.17-5.base.tar.xz"
GPATCH_EXTRAS_FILE="genpatches-3.17-5.extras.tar.xz"
GPATCH_EXPERIMENTAL_FILE="genpatches-3.17-5.experimental.tar.xz"

#####################
# Script            #
#####################

### Prepare folder
CMD="mkdir -p ${SRC_DIR}"
echo "PREPARING: ${CMD}"
${CMD}

### Kernel sources and patches

CMD="wget -N ${KERNEL_URL}/${KERNEL_SHA} -P ${SRC_DIR}"
echo "DOWNLOADING: ${CMD}"
${CMD}

CMD="wget -N ${KERNEL_URL}/${KERNEL_FILE} -P ${SRC_DIR}"
echo "DOWNLOADING: ${CMD}"
${CMD}

# Checking sha265 hash on kernel archiv
CMD="grep `shasum -a 256 ${SRC_DIR}/${KERNEL_FILE}` ${SRC_DIR}/${KERNEL_SHA}"
echo "CHECKING: ${CMD}"
if [[ -z ${CMD} ]]
  then exit
fi

# Extract kernel archiv
CMD="tar -xf ${SRC_DIR}/${KERNEL_FILE} --strip 1"
echo "EXTRACTING: ${CMD}"
${CMD}

### Gentoo patchset
CMD="mkdir -p ${GPATCH_DIR}"
echo "PREPARING: ${CMD}"
${CMD}

CMD="wget -N ${GPATCH_URL}/${GPATCH_BASE_FILE} -P ${SRC_DIR}"
echo "DOWNLOADING: ${CMD}"
${CMD}

CMD="tar -xf ${SRC_DIR}/${GPATCH_BASE_FILE} -C ${GPATCH_DIR}"
echo "EXTRACTING: ${CMD}"
${CMD}

CMD="wget -N ${GPATCH_URL}/${GPATCH_EXTRAS_FILE} -P ${SRC_DIR}"
echo "DOWNLOADING: ${CMD}"
${CMD}

CMD="tar -xf ${SRC_DIR}/${GPATCH_EXTRAS_FILE} -C ${GPATCH_DIR}"
echo "EXTRACTING: ${CMD}"
${CMD}

CMD="wget -N ${GPATCH_URL}/${GPATCH_EXPERIMENTAL_FILE} -P ${SRC_DIR}"
echo "DOWNLOADING: ${CMD}"
${CMD}

CMD="tar -xf ${SRC_DIR}/${GPATCH_EXPERIMENTAL_FILE} -C ${GPATCH_DIR}"
echo "EXTRACTING: ${CMD}"
${CMD}

### Apply gentoo patchset
for patch in $(ls ${GPATCH_DIR}/*.patch* 2>/dev/null); do
  echo "PATCHING: ${patch}"
  patch -t -p1 < ${patch}
done
